<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Biểu đồ & Bảng xếp hạng</title>
  <link rel="stylesheet" href="badminton.css">
</head>
<body>
<style>
  body, h1, h2, h3, h4, h5, h6, p, div, span, a, button, input, select, textarea, label, th, td {
    font-family: 'Times New Roman', Times, serif !important;
  }
  @media (max-width: 900px) {
    #player-stats, #ranking-section, .summary-cards {
      max-width: 100vw;
      margin-left: 0;
      margin-right: 0;
      border-radius: 0;
      padding-left: 6px;
      padding-right: 6px;
    }
    #playerChart {
      max-width: 100vw;
      height: 220px !important;
    }
    .summary-cards {
      gap: 10px;
    }
  }
  @media (max-width: 600px) {
    h2, h3 { font-size: 1.1em !important; }
    .summary-cards {
      flex-direction: column;
      gap: 12px;
    }
    .summary-card { min-width: 0; }
    #playerChart {
      height: 160px !important;
    }
    #ranking-list .ranking-item {
      flex-direction: column;
      align-items: flex-start;
      padding: 10px 8px;
    }
    .rank-right { margin-top: 8px; }
    .rank-badge { width: 32px; height: 32px; font-size: 1.1em; }
    .player-meta .player-name { font-size: 1em; }
    .progress { width: 100px; }
  }
</style>
  <h2>Bảng thống kê</h2>
 <div style="text-align:center;margin:20px;">
    <a class="button" href="index.html">← Quay về trang chính</a>
  </div>
  <section id="player-stats" style="background-color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); margin-bottom: 24px; max-width:1100px; margin-left:auto; margin-right:auto;">
    <h3 style="text-align:center;">Thống kê tổng số ngày</h3>
  <canvas id="playerChart" style="width:100%;max-width:900px;height:320px;display:block;margin:0 auto;"></canvas>
    <div id="playerStatsMessage" style="margin-top:12px;color:#333;text-align:left;"></div>
  </section>

  <section class="summary-cards" aria-label="Tóm tắt người chơi" style="max-width:1100px;margin:0 auto 20px;display:flex;gap:18px;">
    <div id="mostActiveCard" class="summary-card summary-active">
      <div class="summary-left">
        <div class="summary-title">Người chơi tích cực nhất</div>
        <div class="summary-name">-</div>
        <div class="summary-sub">Chăm thể thao rất tốt!</div>
      </div>
      <div class="summary-right">
        <div class="summary-badge">0 ngày</div>
      </div>
    </div>

    <div id="leastActiveCard" class="summary-card summary-inactive">
      <div class="summary-left">
        <div class="summary-title">Cần cố gắng hơn</div>
        <div class="summary-name">-</div>
        <div class="summary-sub">Hãy tham gia nhiều hơn nhé!</div>
      </div>
      <div class="summary-right">
        <div class="summary-badge">0 ngày</div>
      </div>
    </div>
  </section>

  <section id="ranking-section" style="background-color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); margin-bottom: 30px; max-width:1100px; margin-left:auto; margin-right:auto;">
    <h3 style="text-align:center;">Bảng xếp hạng chi tiết</h3>
    <div id="ranking-list" class="ranking-list"></div>
  </section>

 

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // computePlayerDays and renderChart used by dashboard
  function computePlayerDays(data) {
    const playerDays = {};
    const lastValue = {};
    data.forEach((entry, index) => {
      Object.keys(entry.players || {}).forEach(player => {
        const cur = parseFloat(String(entry.players[player] || '0').replace(/[^0-9.]/g, '')) || 0;
        if (!(player in lastValue)) {
          // Lần đầu xuất hiện
          playerDays[player] = 1;
        } else if (cur !== lastValue[player]) {
          playerDays[player] = (playerDays[player] || 0) + 1;
        }
        lastValue[player] = cur;
      });
    });
    return Object.entries(playerDays).sort((a, b) => b[1] - a[1]);
  }

  let chartInstance = null;
  function renderChart(sortedPlayers) {
    const labels = sortedPlayers.map(e => e[0]);
    const data = sortedPlayers.map(e => e[1]);
    const ctx = document.getElementById('playerChart')?.getContext('2d');
    if (!ctx) return;
    if (chartInstance) chartInstance.destroy();
    // Color palette for bars
    const colors = [
      'rgba(255, 99, 132, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(75, 192, 192, 0.7)',
      'rgba(153, 102, 255, 0.7)',
      'rgba(255, 159, 64, 0.7)',
      'rgba(199, 199, 199, 0.7)',
      'rgba(255, 99, 71, 0.7)'
    ];
    const barColors = labels.map((_, i) => colors[i % colors.length]);
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Tổng số ngày',
          data,
          backgroundColor: barColors,
          borderColor: barColors.map(c => c.replace('0.7', '1')),
          borderWidth: 1
        }]
      },
      options: { responsive: true, maintainAspectRatio: true }
    });
  }

  // load and render everything
  fetch('data.json').then(r=>r.json()).then(data=>{
    const sorted = computePlayerDays(data);
    // chart
    renderChart(sorted);
    // summary cards
    const max = sorted.length?sorted[0][1]:0; const min = sorted.length?sorted[sorted.length-1][1]:0;
    const most = sorted.filter(p=>p[1]===max).map(p=>p[0]).join(', ')||'-';
    const least = sorted.filter(p=>p[1]===min).map(p=>p[0]).join(', ')||'-';
    const mostCard = document.getElementById('mostActiveCard');
    const leastCard = document.getElementById('leastActiveCard');
    if (mostCard) { mostCard.querySelector('.summary-name').textContent = most; mostCard.querySelector('.summary-badge').textContent = `${max} ngày`; }
    if (leastCard) { leastCard.querySelector('.summary-name').textContent = least; leastCard.querySelector('.summary-badge').textContent = `${min} ngày`; }
    // stats message
    
    const list = document.getElementById('ranking-list');
    if (list) {
      list.innerHTML = '';
      const maxDays = sorted.length?sorted[0][1]:1;
      sorted.forEach(([player,days],idx)=>{
        const pct = Math.round(days/maxDays*100);
        const item = document.createElement('div'); item.className='ranking-item';
        item.innerHTML = `
          <div class="rank-left">
            <div class="rank-badge">${idx+1}</div>
            <div class="player-meta">
              <div class="player-name">${player}</div>
              <div class="player-sub">Hạng #${idx+1}</div>
            </div>
          </div>
          <div class="rank-right">
            <div class="days">${days}</div>
            <div class="days-label">ngày chơi</div>
            <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
          </div>
        `;
        list.appendChild(item);
      });
    }
  }).catch(e=>{console.error('Failed to load data.json',e);});
</script>
</body>
</html>
