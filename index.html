<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ti·ªÅn c·∫ßu l√¥ng</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="badminton.css">
  <audio id="bgMusic" src="sounds/Iframe Ph√©p M√†u (ƒê√†n c√° g·ªó OST) _ Piano _ Mounter x MAYDAYs, Minh T·ªëc [f5IhGVICRjE].mp3" autoplay loop></audio>
<!-- Flatpickr Datepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


</head>
<body>
  <h2>üè∏ Ti·ªÅn c·∫ßu l√¥ng th√°ng</h2>

<style>
  body, h1, h2, h3, h4, h5, h6, p, div, span, a, button, input, select, textarea, label, th, td {
    font-family: 'Times New Roman', Times, serif !important;
  }
  @media (max-width: 768px) {
    #playerChart {
      max-height: 1000px !important;
    }
  }
</style>
<!-- Dashboard link (chart + summary + ranking) -->
<section style="text-align:center;margin:30px 0;">
  <a class="button" href="dashboard.html">üìä M·ªü Dashboard (Bi·ªÉu ƒë·ªì / T√≥m t·∫Øt / B·∫£ng x·∫øp h·∫°ng)</a>
</section>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Shared helpers: compute playerDays and render chart
  let chartInstance = null;

  function computePlayerDays(data) {
    const playerDays = {};
    data.forEach((entry, index) => {
      if (index === 0) return; // keep original behavior: skip first day
      const previousEntry = data[index - 1] || { players: {} };
      Object.keys(entry.players || {}).forEach(player => {
        const cur = parseFloat(String(entry.players[player] || '0').replace(/[^0-9.]/g, '')) || 0;
        const prev = parseFloat(String(previousEntry.players?.[player] || '0').replace(/[^0-9.]/g, '')) || 0;
        if (cur !== prev) playerDays[player] = (playerDays[player] || 0) + 1;
      });
    });
    return Object.entries(playerDays).sort((a, b) => b[1] - a[1]);
  }

  function renderChart(sortedPlayers) {
    const players = sortedPlayers.map(e => e[0]);
    const days = sortedPlayers.map(e => e[1]);
    const ctx = document.getElementById('playerChart')?.getContext('2d');
    if (!ctx) return;
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: players,
        datasets: [{
          label: 'T·ªïng s·ªë ng√†y',
          data: days,
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(255, 159, 64, 0.2)',
            'rgba(199, 199, 199, 0.2)',
            'rgba(255, 99, 71, 0.2)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(255, 99, 71, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: { duration: 1000, easing: 'easeOutBounce' },
        scales: { x: { ticks: { font: { size: 10 } } }, y: { beginAtZero: true } }
      }
    });
  }
</script>


<!-- summary cards are now rendered in-page -->

 
 
 
<div class="filter-wrapper">
  <label for="filter">L·ªçc theo ng√†y: </label>
  <select id="filter">
    <option value="all">T·∫•t c·∫£</option>
  </select>

  <div class="qr-section">
    <button class="qr-button" id="showQrBtn">üì∑ M√£ QR</button>
    <button class="qr-button" id="showAccountBtn">üí≥ S·ªë t√†i kho·∫£n</button>
    <button class="qr-button" onclick=" window.location.href = 'https://dl.vietqr.io/pay?app=mb'" >
      <img src="https://is2-ssl.mzstatic.com/image/thumb/Purple122/v4/f4/0a/b6/f40ab6a2-e67d-e267-9c46-ae03dfa238a9/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png" alt="MBBank" style="height: 20px;">
      Chuy·ªÉn ti·ªÅn qua MBBank
    </button>
  </div>
</div>
<!-- N√∫t chuy·ªÉn ti·ªÅn qua MoMo v·ªõi logo -->


<!-- N√∫t m·ªü app MBBank v·ªõi logo -->






   <!-- Overlay m·ªü ƒë·∫ßu -->
<div id="startOverlay">
  <div class="overlay-content">
  </div>
</div>

<!-- Nh·∫°c n·ªÅn -->




  <div class="qr-popup-overlay" id="accountPopup">
    <div class="qr-popup-content">
      <button class="qr-close-btn" id="closeAccountBtn">‚úñ</button>
      <h3>Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      <p><strong>STK:</strong> <span id="accountNumber">0123413072005</span></p>
      <p><strong>Ng√¢n h√†ng:</strong> MBBank</p>
      <p><strong>Ch·ªß t√†i kho·∫£n:</strong> ƒê·∫∑ng Thanh H√†</p>
      <button class="qr-button" id="copyAccountBtn">üìã Sao ch√©p STK</button>
      <span id="copyMsg" style="display:none;color:green;font-size:0.95rem;">ƒê√£ sao ch√©p!</span>
    </div>
  </div>

  <div class="qr-popup-overlay" id="historyPopup">
  <div class="qr-popup-content">
    <button class="qr-close-btn" id="closeHistoryBtn">‚úñ</button>
    <h3>L·ªãch s·ª≠ ch·ªânh s·ª≠a</h3>
    <div id="historyContent">
      <p>ƒêang t·∫£i...</p>
    </div>
  </div>
</div>

  <div class="card-container" id="cardContainer"></div>



  <div class="qr-popup-overlay" id="qrPopup">
    <div class="qr-popup-content">
      <button class="qr-close-btn" id="closeQrBtn">‚úñ</button>
      <img src="img/Qr.jpg" alt="M√£ QR">
      <span>M√£ QR c·ªßa b·∫°n</span>
    </div>
  </div>

  <div class="qr-popup-overlay" id="statsPopup">
  <div class="qr-popup-content">
    <button class="qr-close-btn" id="closeStatsBtn">‚úñ</button>
    <h3>Th·ªëng k√™ s·ªë ng√†y ch∆°i</h3>
    <table id="statsTable" style="width: 100%; border-collapse: collapse; text-align: left;">
      <thead>
        <tr>
          <th style="border-bottom: 2px solid #ddd; padding: 8px;">T√™n</th>
          <th style="border-bottom: 2px solid #ddd; padding: 8px;">S·ªë ng√†y ch∆°i</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be dynamically generated -->
      </tbody>
    </table>
  </div>
</div>

<!-- ranking list is now rendered in-page -->

<script src="badminton.js">
  
 </script>
 <script>
  const showStatsBtn = document.getElementById('showStatsBtn');
if (showStatsBtn) {
  showStatsBtn.addEventListener('click', () => {
    const statsPopup = document.getElementById('statsPopup');
    statsPopup.style.display = 'flex';

    const statsTableBody = document.querySelector('#statsTable tbody');
    statsTableBody.innerHTML = ''; // Clear previous rows
      // Reuse computePlayerDays if available to avoid duplicate logic
      (async () => {
        try {
          let sorted = window._playerStatsCache;
          if (!sorted) {
            const resp = await fetch('data.json');
            const data = await resp.json();
            sorted = computePlayerDays ? computePlayerDays(data) : Object.entries((() => {
              const pc = {};
              data.forEach(entry => Object.keys(entry.players || {}).forEach(p => pc[p] = (pc[p] || 0) + 1));
              return pc;
            })()).sort((a, b) => b[1] - a[1]);
            window._playerStatsCache = sorted;
          }

          sorted.forEach(([player, days]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="border-bottom: 1px solid #ddd; padding: 8px;">${player}</td>
              <td style="border-bottom: 1px solid #ddd; padding: 8px;">${days}</td>
            `;
            statsTableBody.appendChild(row);
          });
        } catch (e) {
          console.error('Failed to load stats for popup', e);
          statsTableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#c00;padding:12px;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
        }
      })();
  });
} 

// Keep closeStatsBtn binding safe
const closeStatsBtn = document.getElementById('closeStatsBtn');
if (closeStatsBtn) {
  closeStatsBtn.addEventListener('click', () => {
    const el = document.getElementById('statsPopup');
    if (el) el.style.display = 'none';
  });
}

  

// Populate ranking table safely after DOM ready
document.addEventListener('DOMContentLoaded', () => {
  const rankingTableBody = document.querySelector('.ranking-table tbody');
  const rankingList = document.getElementById('ranking-list');
  if (!rankingTableBody && !rankingList) return;

  fetch('data.json')
    .then(resp => resp.json())
    .then(data => {
  console.log('Loaded data.json, entries:', data.length);
  const sortedPlayers = computePlayerDays(data);
  console.log('Computed playerDays:', sortedPlayers);

      // Populate summary cards (most active / needs improvement)
      try {
        const mostCard = document.getElementById('mostActiveCard');
        const leastCard = document.getElementById('leastActiveCard');
        if (mostCard || leastCard) {
          const maxDays = sortedPlayers.length ? sortedPlayers[0][1] : 0;
          const minDays = sortedPlayers.length ? sortedPlayers[sortedPlayers.length - 1][1] : 0;
          const mostNames = sortedPlayers.filter(p => p[1] === maxDays).map(p => p[0]).join(', ') || '-';
          const leastNames = sortedPlayers.filter(p => p[1] === minDays).map(p => p[0]).join(', ') || '-';

          if (mostCard) {
            const nameEl = mostCard.querySelector('.summary-name');
            const badgeEl = mostCard.querySelector('.summary-badge');
            if (nameEl) nameEl.textContent = mostNames;
            if (badgeEl) {
              if (badgeEl.textContent !== `${maxDays} ng√†y`) {
                badgeEl.textContent = `${maxDays} ng√†y`;
                badgeEl.classList.add('updated');
                setTimeout(() => badgeEl.classList.remove('updated'), 1000);
              }
            }
          }

          if (leastCard) {
            const nameEl = leastCard.querySelector('.summary-name');
            const badgeEl = leastCard.querySelector('.summary-badge');
            if (nameEl) nameEl.textContent = leastNames;
            if (badgeEl) {
              if (badgeEl.textContent !== `${minDays} ng√†y`) {
                badgeEl.textContent = `${minDays} ng√†y`;
                badgeEl.classList.add('updated');
                setTimeout(() => badgeEl.classList.remove('updated'), 1000);
              }
            }
          }
        }
      } catch (e) {
        console.warn('Failed to populate summary cards', e);
      }

        // Update playerStatsMessage (most/least with ties)
        try {
          const playerStatsMessage = document.getElementById('playerStatsMessage');
          if (playerStatsMessage) {
            if (!sortedPlayers || sortedPlayers.length === 0) {
              playerStatsMessage.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.';
            } else {
              const maxDays = sortedPlayers[0][1];
              const minDays = sortedPlayers[sortedPlayers.length - 1][1];
              const mostNames = sortedPlayers.filter(p => p[1] === maxDays).map(p => p[0]).join(', ');
              const leastNames = sortedPlayers.filter(p => p[1] === minDays).map(p => p[0]).join(', ');
              playerStatsMessage.innerHTML = `Ng∆∞·ªùi ch∆°i nhi·ªÅu nh·∫•t: <strong>${mostNames}</strong> (${maxDays} ng√†y) - ChƒÉm th·ªÉ thao r·∫•t t·ªët!<br>Ng∆∞·ªùi ch∆°i √≠t nh·∫•t: <strong>${leastNames}</strong> (${minDays} ng√†y) - C·∫ßn c·ªë g·∫Øng h∆°n.`;
              playerStatsMessage.style.fontSize = '0.9em';
              playerStatsMessage.style.textAlign = 'left';
            }
          }
        } catch (e) {
          console.warn('Failed to update playerStatsMessage', e);
        }

      // Fallback table rendering (if table still exists)
      if (rankingTableBody) {
        rankingTableBody.innerHTML = '';
        if (sortedPlayers.length === 0) {
          rankingTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#666;padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        } else {
          sortedPlayers.forEach(([player, days], idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${player}</td>
              <td>${days}</td>
            `;
            rankingTableBody.appendChild(tr);
          });
        }
      }

      // New card/list rendering
      if (rankingList) {
        rankingList.innerHTML = '';
        const maxDays = sortedPlayers.length ? sortedPlayers[0][1] : 1;

        sortedPlayers.forEach(([player, days], idx) => {
          const percent = Math.round((days / maxDays) * 100);
          const item = document.createElement('div');
          item.className = 'ranking-item';
          item.innerHTML = `
            <div class="rank-left">
              <div class="rank-badge">${idx + 1}</div>
              <div class="player-meta">
                <div class="player-name">${player}</div>
                <div class="player-sub">H·∫°ng #${idx + 1}</div>
              </div>
            </div>
            <div class="rank-right">
              <div class="days">${days}</div>
              <div class="days-label">ng√†y ch∆°i</div>
              <div class="progress"><div class="progress-bar" style="width: ${percent}%"></div></div>
            </div>
          `;
          rankingList.appendChild(item);
        });

        if (sortedPlayers.length === 0) {
          rankingList.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
        }
      }

  // Render chart from same data
  try { renderChart(sortedPlayers); } catch (e) { console.warn('Failed to render chart', e); }
    })
    .catch(err => {
      console.error('Error loading ranking data:', err);
      if (rankingTableBody) rankingTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#c00;padding:20px;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
      if (rankingList) rankingList.innerHTML = '<div style="text-align:center;color:#c00;padding:20px;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    });
});
</script>

</body>
</html>
